<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多数据库同步管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f8f9fa; }
        .dashboard-card { margin-bottom: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .health-indicator { text-align: center; padding: 20px; border-radius: 10px; margin-bottom: 15px; }
        .status-good { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .status-bad { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .status-warning { background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; }
        .log-entry { padding: 10px; margin-bottom: 5px; border-radius: 5px; font-size: 14px; }
        .log-success { background-color: #d4edda; border-left: 4px solid #28a745; }
        .log-error { background-color: #f8d7da; border-left: 4px solid #dc3545; }
        .log-info { background-color: #d1ecf1; border-left: 4px solid #17a2b8; }
        .refresh-btn { margin-bottom: 15px; }
        #logs-container { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-between align-items-center mb-5">
            <div class="col">
                <h1><i class="fa fa-database"></i> 多数据库同步管理系统</h1>
            </div>
            <div class="col text-end">
                <div class="user-info">
                    <i class="fa fa-user-circle-o"></i>
                    <span id="username"></span>
                    <span class="badge bg-primary" id="user-role"></span>
                    <button class="btn btn-sm btn-danger" onclick="logout()">
                        <i class="fa fa-sign-out"></i> 登出
                    </button>
                </div>
            </div>
        </div>

        <!-- 数据库健康状态 -->
        <div class="card dashboard-card">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title"><i class="fa fa-heartbeat"></i> 数据库健康状态</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div id="mysql-status" class="health-indicator status-warning">
                            <h4><i class="fa fa-database"></i> MySQL</h4>
                            <div id="mysql-status-text">加载中...</div>
                            <div id="mysql-tables" class="mt-2"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div id="sqlserver-status" class="health-indicator status-warning">
                            <h4><i class="fa fa-database"></i> SQL Server</h4>
                            <div id="sqlserver-status-text">加载中...</div>
                            <div id="sqlserver-tables" class="mt-2"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div id="oracle-status" class="health-indicator status-warning">
                            <h4><i class="fa fa-database"></i> Oracle</h4>
                            <div id="oracle-status-text">加载中...</div>
                            <div id="oracle-tables" class="mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 同步状态与报表 -->
        <div class="card dashboard-card">
            <div class="card-header bg-success text-white">
                <h3 class="card-title"><i class="fa fa-line-chart"></i> 状态与报表</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-3">
                            <span class="badge bg-success me-2" id="status-lamp">在线</span>
                            <span class="text-muted">数据库状态实时展示</span>
                        </div>
                        <p class="text-muted">系统会周期性自检三库连接并展示统计信息。</p>
                    </div>
                    <div class="col-md-6">
                        <canvas id="pending-chart" height="120"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据管理面板 -->
        <div class="card dashboard-card">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title"><i class="fa fa-database"></i> 数据管理面板</h3>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title">多条件检索</h5>
                                <form id="search-form">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label for="search-content" class="form-label">题目内容</label>
                                            <input type="text" class="form-control" id="search-content" placeholder="请输入题目内容关键词">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="search-min-score" class="form-label">最低分数</label>
                                            <input type="number" class="form-control" id="search-min-score" placeholder="最低分数" min="0" step="0.5">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="search-max-score" class="form-label">最高分数</label>
                                            <input type="number" class="form-control" id="search-max-score" placeholder="最高分数" min="0" step="0.5">
                                        </div>
                                        <div class="col-md-2 align-self-end">
                                            <button type="submit" class="btn btn-primary w-100">
                                                <i class="fa fa-search"></i> 搜索
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title">添加新题目</h5>
                                <form id="add-question-form">
                                    <div class="mb-3">
                                        <label for="question-content" class="form-label">题目内容</label>
                                        <textarea class="form-control" id="question-content" rows="3" required placeholder="请输入题目内容"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="question-answer" class="form-label">答案</label>
                                        <textarea class="form-control" id="question-answer" rows="2" required placeholder="请输入答案"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="question-score" class="form-label">分数</label>
                                        <input type="number" class="form-control" id="question-score" required placeholder="请输入分数" min="0" step="0.5">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">目标数据库</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="mysql" id="target-db-mysql" checked>
                                            <label class="form-check-label" for="target-db-mysql">MySQL</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="sqlserver" id="target-db-sqlserver" checked>
                                            <label class="form-check-label" for="target-db-sqlserver">SQL Server</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="oracle" id="target-db-oracle" checked>
                                            <label class="form-check-label" for="target-db-oracle">Oracle</label>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary"><i class="fa fa-plus"></i> 添加题目并同步</button>
                                    <button type="reset" class="btn btn-secondary"><i class="fa fa-refresh"></i> 重置</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <h5>题目数据表格</h5>
                        <div id="questions-table" class="mt-3">
                            <div class="alert alert-info"><i class="fa fa-info-circle"></i> 点击"搜索"或"刷新"按钮获取题目列表</div>
                        </div>
                        <button id="refresh-questions" class="btn btn-primary mt-2 refresh-btn">
                            <i class="fa fa-refresh"></i> 刷新题目列表
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 同步日志 -->
        <div class="card dashboard-card">
            <div class="card-header bg-info text-white">
                <h3 class="card-title"><i class="fa fa-clock-o"></i> 同步日志流</h3>
            </div>
            <div class="card-body">
                <button id="refresh-logs" class="btn btn-primary refresh-btn"><i class="fa fa-refresh"></i> 刷新日志</button>
                <div id="logs-container">
                    <div class="log-entry log-info">
                        <i class="fa fa-info-circle"></i> 正在加载同步日志...
                    </div>
                </div>
            </div>
        </div>

        <!-- 同步监控中心 -->
        <div class="card dashboard-card">
            <div class="card-header bg-warning text-white">
                <h3 class="card-title"><i class="fa fa-line-chart"></i> 同步监控中心</h3>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title"><i class="fa fa-pie-chart"></i> 同步成功率统计</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="sync-pie-chart" width="400" height="400"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title"><i class="fa fa-exclamation-triangle"></i> 异常记录列表</h5>
                            </div>
                            <div class="card-body">
                                <div id="exception-logs-container" style="max-height: 300px; overflow-y: auto;">
                                    <div class="text-center text-muted"><i class="fa fa-info-circle"></i> 加载中...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title"><i class="fa fa-list"></i> 最新同步日志</h5>
                            </div>
                            <div class="card-body">
                                <div style="max-height: 250px; overflow-y: auto;">
                                    <table class="table table-striped table-bordered" id="sync-logs-table">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th>源库</th>
                                                <th>目标库</th>
                                                <th>操作类型</th>
                                                <th>事件类型</th>
                                                <th>状态</th>
                                                <th>错误信息</th>
                                                <th>时间</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="sync-logs-tbody">
                                            <tr>
                                                <td colspan="8" class="text-center text-muted">
                                                    <i class="fa fa-info-circle"></i> 加载中...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑题目模态框 -->
    <div class="modal fade" id="edit-question-modal" tabindex="-1" aria-labelledby="edit-question-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="edit-question-modal-label">编辑题目</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-question-form">
                        <input type="hidden" id="edit-question-id">
                        <input type="hidden" id="edit-question-guid">
                        <div class="mb-3">
                            <label for="edit-question-content" class="form-label">题目内容</label>
                            <textarea class="form-control" id="edit-question-content" rows="3" required placeholder="请输入题目内容"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="edit-question-answer" class="form-label">答案</label>
                            <textarea class="form-control" id="edit-question-answer" rows="2" required placeholder="请输入答案"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="edit-question-score" class="form-label">分数</label>
                            <input type="number" class="form-control" id="edit-question-score" required placeholder="请输入分数" min="0" step="0.5">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-edit-question">保存修改并同步</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '';
        let pendingChart = null;
        let syncPieChart = null;

        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userInfo');
            window.location.href = 'login.html';
        }

        function handleApiError(error, fallback = '请求失败，请稍后重试') {
            console.error(error);
            Swal.fire('错误', error.message || fallback, 'error');
        }

        async function fetchJson(path, options = {}) {
            const headers = { ...(options.headers || {}), ...getAuthHeaders() };
            if (options.body && !headers['Content-Type']) {
                headers['Content-Type'] = 'application/json';
            }
            const response = await fetch(`${API_BASE}${path}`, { ...options, headers });
            const data = await response.json().catch(() => ({}));
            if (!response.ok) {
                throw new Error(data.detail || data.message || response.statusText);
            }
            return data;
        }

        async function ensureLogin() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        async function loadUserInfo() {
            try {
                const data = await fetchJson('/api/auth/me');
                $('#username').text(data.username);
                $('#user-role').text(data.role);
                localStorage.setItem('userInfo', JSON.stringify({ username: data.username, role: data.role }));
            } catch (error) {
                const cached = JSON.parse(localStorage.getItem('userInfo') || '{}');
                if (cached.username) {
                    $('#username').text(cached.username);
                    $('#user-role').text(cached.role || '');
                } else {
                    handleApiError(error, '获取用户信息失败，请重新登录');
                    logout();
                }
            }
        }

        function updateSingleDbStatus(dbName, info) {
            const statusElement = $(`#${dbName}-status`);
            const statusTextElement = $(`#${dbName}-status-text`);
            const tablesElement = $(`#${dbName}-tables`);
            statusElement.removeClass('status-good status-bad status-warning');
            if (info.status === 'success') {
                statusElement.addClass('status-good');
                statusTextElement.html('<i class="fa fa-check-circle"></i> 连接成功');
            } else {
                statusElement.addClass('status-bad');
                statusTextElement.html(`<i class="fa fa-times-circle"></i> ${info.message || '连接失败'}`);
            }
            if (info.table_counts) {
                const tablesHtml = `
                    <h6>数据量:</h6>
                    <ul class="list-unstyled">
                        <li><strong>T_USERS:</strong> ${info.table_counts.T_USERS ?? '-'}</li>
                        <li><strong>T_QUESTIONS:</strong> ${info.table_counts.T_QUESTIONS ?? '-'}</li>
                        <li><strong>T_EXAMS:</strong> ${info.table_counts.T_EXAMS ?? '-'}</li>
                        <li><strong>T_SCORES:</strong> ${info.table_counts.T_SCORES ?? '-'}</li>
                        <li><strong>T_SYNC_LOGS:</strong> ${info.table_counts.T_SYNC_LOGS ?? '-'}</li>
                    </ul>`;
                tablesElement.html(tablesHtml);
            } else {
                tablesElement.empty();
            }
        }

        async function loadDbStatus() {
            try {
                const data = await fetchJson('/db/status');
                Object.entries(data).forEach(([dbName, info]) => updateSingleDbStatus(dbName, info));
            } catch (error) {
                handleApiError(error, '获取数据库状态失败');
            }
        }

        function renderQuestionsTable(data) {
            const questionsTable = $('#questions-table');
            if (!data.length) {
                questionsTable.html('<div class="alert alert-info"><i class="fa fa-info-circle"></i> 暂无题目数据</div>');
                return;
            }
            let tableHtml = `
                <table class="table table-striped table-bordered">
                    <thead class="thead-dark">
                        <tr>
                            <th>题目ID</th>
                            <th>GUID</th>
                            <th>题目内容</th>
                            <th>答案</th>
                            <th>分数</th>
                            <th>更新时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>`;
            data.forEach(q => {
                tableHtml += `
                    <tr>
                        <td>${q.id ?? '-'}</td>
                        <td>${q.guid || '-'}</td>
                        <td>${q.content}</td>
                        <td>${q.answer}</td>
                        <td>${q.score}</td>
                        <td>${q.updated_at ? new Date(q.updated_at).toLocaleString('zh-CN') : '无'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary edit-question-btn"
                                data-id="${q.id || ''}" data-guid="${q.guid || ''}"
                                data-content="${q.content}" data-answer="${q.answer}" data-score="${q.score}">
                                <i class="fa fa-edit"></i> 编辑
                            </button>
                        </td>
                    </tr>`;
            });
            tableHtml += '</tbody></table>';
            questionsTable.html(tableHtml);
            bindEditQuestionEvents();
        }

        async function getQuestionsList() {
            try {
                const data = await fetchJson('/api/questions');
                renderQuestionsTable(data.questions || []);
            } catch (error) {
                handleApiError(error, '获取题目列表失败');
            }
        }

        async function searchQuestions() {
            const content = $('#search-content').val().trim();
            const minScore = $('#search-min-score').val();
            const maxScore = $('#search-max-score').val();
            const params = new URLSearchParams();
            if (content) params.append('content', content);
            if (minScore) params.append('min_score', minScore);
            if (maxScore) params.append('max_score', maxScore);
            try {
                const data = await fetchJson(`/api/questions/search?${params.toString()}`);
                renderQuestionsTable(data.questions || []);
            } catch (error) {
                handleApiError(error, '查询题目失败');
            }
        }

        function bindEditQuestionEvents() {
            $('.edit-question-btn').click(function() {
                $('#edit-question-id').val($(this).data('id'));
                $('#edit-question-guid').val($(this).data('guid'));
                $('#edit-question-content').val($(this).data('content'));
                $('#edit-question-answer').val($(this).data('answer'));
                $('#edit-question-score').val($(this).data('score'));
                const modal = new bootstrap.Modal(document.getElementById('edit-question-modal'));
                modal.show();
            });
        }

        async function saveEditedQuestion() {
            const guid = $('#edit-question-guid').val();
            if (!guid) return;
            const payload = {
                question: {
                    content: $('#edit-question-content').val(),
                    answer: $('#edit-question-answer').val(),
                    score: parseFloat($('#edit-question-score').val())
                },
                target_dbs: ['mysql', 'sqlserver', 'oracle']
            };
            try {
                await fetchJson(`/api/questions/${guid}`, { method: 'PUT', body: JSON.stringify(payload) });
                Swal.fire('成功', '题目已更新并同步', 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('edit-question-modal'));
                modal.hide();
                getQuestionsList();
            } catch (error) {
                handleApiError(error, '更新题目失败');
            }
        }

        async function addQuestion(event) {
            event.preventDefault();
            const content = $('#question-content').val();
            const answer = $('#question-answer').val();
            const score = parseFloat($('#question-score').val());
            const targetDbs = [];
            if ($('#target-db-mysql').is(':checked')) targetDbs.push('mysql');
            if ($('#target-db-sqlserver').is(':checked')) targetDbs.push('sqlserver');
            if ($('#target-db-oracle').is(':checked')) targetDbs.push('oracle');
            if (!targetDbs.length) {
                Swal.fire('提示', '请至少选择一个目标库', 'warning');
                return;
            }
            const payload = {
                question: { content, answer, score },
                target_dbs: targetDbs
            };
            try {
                await fetchJson('/api/questions', { method: 'POST', body: JSON.stringify(payload) });
                Swal.fire('成功', '题目已添加并同步', 'success');
                $('#add-question-form')[0].reset();
                $('#target-db-mysql, #target-db-sqlserver, #target-db-oracle').prop('checked', true);
                getQuestionsList();
            } catch (error) {
                handleApiError(error, '添加题目失败');
            }
        }

        function renderSyncPieChart(successCount, failureCount) {
            const ctx = document.getElementById('sync-pie-chart').getContext('2d');
            if (syncPieChart) syncPieChart.destroy();
            syncPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['成功', '失败'],
                    datasets: [{
                        data: [successCount, failureCount],
                        backgroundColor: ['#28a745', '#dc3545'],
                        borderColor: ['#218838', '#c82333'],
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function renderPendingChart(pendingCount, total) {
            const ctx = document.getElementById('pending-chart').getContext('2d');
            const done = Math.max(total - pendingCount, 0);
            if (pendingChart) pendingChart.destroy();
            pendingChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['处理中', '已完成'], datasets: [{ data: [pendingCount, done], backgroundColor: ['#ffc107', '#20c997'] }] },
                options: { plugins: { legend: { position: 'bottom' } } }
            });
        }

        async function loadSyncStats() {
            try {
                const data = await fetchJson('/api/stats');
                let success = 0, failed = 0, pending = 0;
                Object.values(data).forEach(item => {
                    success += item.success_count || 0;
                    failed += item.failed_count || 0;
                    pending += item.pending_count || 0;
                });
                renderSyncPieChart(success, failed);
                renderPendingChart(pending, success + failed + pending);
            } catch (error) {
                handleApiError(error, '获取同步统计失败');
            }
        }

        function renderLogs(list) {
            const logsContainer = $('#logs-container');
            logsContainer.empty();
            if (!list.length) {
                logsContainer.html('<div class="log-entry log-info">没有同步日志</div>');
                return;
            }
            list.forEach(log => {
                const logClass = log.status === 'FAILED' ? 'log-error' : (log.status === 'SUCCESS' ? 'log-success' : 'log-info');
                const dbLabel = log.dbName ? `${log.dbName} - ` : '';
                const logHtml = `
                    <div class="log-entry ${logClass}">
                        <strong>${dbLabel}${new Date(log.created_at).toLocaleString('zh-CN')}</strong>
                        <div><strong>事件:</strong> ${log.event_type || '-'}</div>
                        <div><strong>状态:</strong> ${log.status || '-'}</div>
                        ${log.error_msg ? `<div><strong>错误:</strong> ${log.error_msg}</div>` : ''}
                    </div>`;
                logsContainer.append(logHtml);
            });
        }

        async function getSyncLogs() {
            try {
                const data = await fetchJson('/api/sync/logs?limit=50');
                const allLogs = [];
                Object.entries(data).forEach(([dbName, payload]) => {
                    (payload.logs || []).forEach(log => allLogs.push({ ...log, dbName }));
                });
                allLogs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                renderLogs(allLogs.slice(0, 20));
                renderExceptionLogs(allLogs);
                renderLatestSyncLogs(allLogs);
            } catch (error) {
                handleApiError(error, '获取同步日志失败');
            }
        }

        function renderExceptionLogs(logs) {
            const exceptionLogsContainer = $('#exception-logs-container');
            exceptionLogsContainer.empty();
            const exceptionLogs = logs.filter(log => log.status === 'FAILED');
            if (!exceptionLogs.length) {
                exceptionLogsContainer.html('<div class="alert alert-success text-center"><i class="fa fa-check-circle"></i> 没有异常记录</div>');
                return;
            }
            exceptionLogs.forEach(log => {
                const logHtml = `
                    <div class="card mb-3 border-danger">
                        <div class="card-header bg-danger text-white">
                            <div class="row">
                                <div class="col-sm-6"><strong><i class="fa fa-database"></i> ${log.dbName}</strong></div>
                                <div class="col-sm-6 text-end"><small>${new Date(log.created_at).toLocaleString('zh-CN')}</small></div>
                            </div>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title"><i class="fa fa-exclamation-triangle"></i> ${log.event_type || '-'}</h6>
                            <p class="card-text"><strong>错误信息:</strong> ${log.error_msg || '-'}</p>
                        </div>
                    </div>`;
                exceptionLogsContainer.append(logHtml);
            });
        }

        function renderLatestSyncLogs(logs) {
            const tbody = $('#sync-logs-tbody');
            tbody.empty();
            const latestLogs = [...logs].sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 10);
            if (!latestLogs.length) {
                tbody.html('<tr><td colspan="8" class="text-center text-muted"><i class="fa fa-info-circle"></i> 没有同步日志</td></tr>');
                return;
            }
            latestLogs.forEach(log => {
                let statusClass = 'badge-secondary';
                if (log.status === 'SUCCESS') statusClass = 'badge-success';
                else if (log.status === 'FAILED') statusClass = 'badge-danger';
                else if (log.status === 'PENDING') statusClass = 'badge-warning';
                const syncButton = log.status === 'PENDING' ? `
                    <button class="btn btn-sm btn-primary execute-sync-btn" data-log-id="${log.id}" title="立即同步">
                        <i class="fa fa-play"></i> 立即同步
                    </button>` : '';
                const rowHtml = `
                    <tr data-log-id="${log.id}">
                        <td>${log.source_db || log.dbName || '-'}</td>
                        <td>${log.target_db || '-'}</td>
                        <td>${log.operation_type || '-'}</td>
                        <td>${log.event_type || '-'}</td>
                        <td><span class="badge ${statusClass}">${log.status || '-'}</span></td>
                        <td>${log.error_msg || '-'}</td>
                        <td>${log.created_at ? new Date(log.created_at).toLocaleString('zh-CN') : '-'}</td>
                        <td>${syncButton}</td>
                    </tr>`;
                tbody.append(rowHtml);
            });
            bindExecuteSyncEvents();
        }

        function bindExecuteSyncEvents() {
            $('.execute-sync-btn').click(async function() {
                const logId = $(this).data('log-id');
                try {
                    await fetchJson(`/api/sync/execute/${logId}`, { method: 'POST' });
                    Swal.fire('完成', '同步任务已执行', 'success');
                    getSyncLogs();
                } catch (error) {
                    handleApiError(error, '执行同步任务失败');
                }
            });
        }

        $(document).ready(async function() {
            if (!await ensureLogin()) return;
            await loadUserInfo();
            await loadDbStatus();
            await loadSyncStats();
            await getQuestionsList();
            await getSyncLogs();

            $('#add-question-form').on('submit', addQuestion);
            $('#search-form').on('submit', function(e) { e.preventDefault(); searchQuestions(); });
            $('#refresh-questions').on('click', getQuestionsList);
            $('#refresh-logs').on('click', getSyncLogs);
            $('#save-edit-question').on('click', saveEditedQuestion);

            setInterval(loadDbStatus, 20000);
            setInterval(loadSyncStats, 20000);
            setInterval(getSyncLogs, 15000);
        });
    </script>
</body>
</html>
