<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多数据库同步控制台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background: #f5f7fb; }
        .card { box-shadow: 0 2px 12px rgba(0,0,0,0.05); }
        .status-pill { font-weight: 600; }
        .table-responsive { max-height: 460px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="bi bi-database"></i> 多数据库同步控制台</a>
            <div class="d-flex align-items-center gap-3 text-white">
                <span id="nav-username" class="fw-semibold"></span>
                <span id="nav-role" class="badge bg-light text-dark"></span>
                <button class="btn btn-sm btn-outline-light" id="logout-btn"><i class="bi bi-box-arrow-right"></i> 退出</button>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <div class="row g-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-plug"></i> 数据库连接状态</h5>
                            <button class="btn btn-sm btn-outline-primary" id="refresh-status">刷新</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3" id="db-status-cards">
                            <!-- status cards -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card h-100">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-list-check"></i> 题目列表</h5>
                            <div class="d-flex gap-2">
                                <input type="text" id="search-keyword" class="form-control form-control-sm" placeholder="内容关键词">
                                <input type="number" id="search-min" class="form-control form-control-sm" placeholder="最低分">
                                <input type="number" id="search-max" class="form-control form-control-sm" placeholder="最高分">
                                <button class="btn btn-sm btn-outline-primary" id="search-btn"><i class="bi bi-search"></i> 查询</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead>
                                    <tr>
                                        <th>GUID</th>
                                        <th>内容</th>
                                        <th>分数</th>
                                        <th>更新时间</th>
                                        <th class="text-end">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="questions-body">
                                    <tr><td colspan="5" class="text-center text-muted">正在加载...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card mb-3">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-plus-circle"></i> 新增题目</h5>
                    </div>
                    <div class="card-body">
                        <form id="create-form">
                            <div class="mb-2">
                                <label class="form-label">内容</label>
                                <textarea class="form-control" id="create-content" rows=2 required></textarea>
                            </div>
                            <div class="mb-2">
                                <label class="form-label">答案</label>
                                <textarea class="form-control" id="create-answer" rows=2 required></textarea>
                            </div>
                            <div class="mb-2">
                                <label class="form-label">分数</label>
                                <input type="number" step="0.5" min="0" class="form-control" id="create-score" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">直接写入数据库</label>
                                <div class="form-check">
                                    <input class="form-check-input target-db" type="checkbox" value="mysql" id="create-db-mysql" checked>
                                    <label class="form-check-label" for="create-db-mysql">MySQL</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input target-db" type="checkbox" value="sqlserver" id="create-db-sqlserver" checked>
                                    <label class="form-check-label" for="create-db-sqlserver">SQL Server</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input target-db" type="checkbox" value="oracle" id="create-db-oracle" checked>
                                    <label class="form-check-label" for="create-db-oracle">Oracle</label>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">创建并同步</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-arrow-repeat"></i> 手动同步任务</h5>
                        <button class="btn btn-sm btn-outline-primary" id="refresh-tasks">刷新</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>目标库</th>
                                        <th>状态</th>
                                        <th class="text-end">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="tasks-body">
                                    <tr><td colspan="4" class="text-center text-muted">暂无任务</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑模态框 -->
    <div class="modal fade" id="edit-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑题目</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-guid">
                    <div class="mb-2">
                        <label class="form-label">内容</label>
                        <textarea class="form-control" id="edit-content" rows=2 required></textarea>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">答案</label>
                        <textarea class="form-control" id="edit-answer" rows=2 required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">分数</label>
                        <input type="number" step="0.5" min="0" class="form-control" id="edit-score" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">直接同步到</label>
                        <div class="form-check">
                            <input class="form-check-input edit-target" type="checkbox" value="mysql" id="edit-db-mysql" checked>
                            <label class="form-check-label" for="edit-db-mysql">MySQL</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input edit-target" type="checkbox" value="sqlserver" id="edit-db-sqlserver" checked>
                            <label class="form-check-label" for="edit-db-sqlserver">SQL Server</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input edit-target" type="checkbox" value="oracle" id="edit-db-oracle" checked>
                            <label class="form-check-label" for="edit-db-oracle">Oracle</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-edit">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '';
        const DB_NAMES = { mysql: 'MySQL', sqlserver: 'SQL Server', oracle: 'Oracle' };

        function getToken() {
            return localStorage.getItem('token');
        }

        function authHeaders() {
            const token = getToken();
            return token ? { Authorization: `Bearer ${token}` } : {};
        }

        async function fetchJson(path, options = {}) {
            const headers = { 'Content-Type': 'application/json', ...(options.headers || {}), ...authHeaders() };
            const resp = await fetch(`${API_BASE}${path}`, { ...options, headers });
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) {
                throw new Error(data.detail || data.message || resp.statusText);
            }
            return data;
        }

        function requireLogin() {
            if (!getToken()) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        function renderStatusCard(dbName, info) {
            const statusClass = info.status === 'online' ? 'text-success' : 'text-danger';
            const counts = info.table_counts || {};
            return `
                <div class="col-md-4">
                    <div class="p-3 border rounded h-100 bg-light">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="fw-semibold">${DB_NAMES[dbName] || dbName}</div>
                            <span class="status-pill ${statusClass}">${info.status}</span>
                        </div>
                        <div class="small text-muted">${info.message || ''}</div>
                        <ul class="mt-2 mb-0 small list-unstyled">
                            <li>T_USERS: ${counts.T_USERS ?? '-'}</li>
                            <li>T_QUESTIONS: ${counts.T_QUESTIONS ?? '-'}</li>
                            <li>T_EXAMS: ${counts.T_EXAMS ?? '-'}</li>
                            <li>T_SCORES: ${counts.T_SCORES ?? '-'}</li>
                            <li>T_SYNC_LOGS: ${counts.T_SYNC_LOGS ?? '-'}</li>
                        </ul>
                    </div>
                </div>`;
        }

        async function loadDbStatus() {
            try {
                const data = await fetchJson('/api/v2/db/status');
                const container = document.getElementById('db-status-cards');
                container.innerHTML = Object.entries(data).map(([k, v]) => renderStatusCard(k, v)).join('');
            } catch (err) {
                alert('获取数据库状态失败：' + err.message);
            }
        }

        function renderQuestions(list) {
            const body = document.getElementById('questions-body');
            if (!list.length) {
                body.innerHTML = '<tr><td colspan="5" class="text-center text-muted">暂无数据</td></tr>';
                return;
            }
            body.innerHTML = list.map(q => `
                <tr>
                    <td class="small">${q.guid}</td>
                    <td>${q.content}</td>
                    <td>${q.score}</td>
                    <td>${q.updated_at || '-'}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-1" data-guid="${q.guid}" data-content="${q.content}" data-answer="${q.answer}" data-score="${q.score}" onclick="openEdit(this)">编辑</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete('${q.guid}')">删除</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadQuestions() {
            try {
                const params = new URLSearchParams();
                const keyword = document.getElementById('search-keyword').value.trim();
                const minScore = document.getElementById('search-min').value;
                const maxScore = document.getElementById('search-max').value;
                if (keyword) params.set('content', keyword);
                if (minScore) params.set('min_score', minScore);
                if (maxScore) params.set('max_score', maxScore);
                const data = await fetchJson(`/api/v2/questions?${params.toString()}`);
                renderQuestions(data);
            } catch (err) {
                alert('加载题目失败：' + err.message);
            }
        }

        function selectedTargets(selector) {
            return Array.from(document.querySelectorAll(selector + ':checked')).map(el => el.value);
        }

        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const target = selectedTargets('.target-db');
            if (!target.length) {
                alert('请选择至少一个数据库');
                return;
            }
            try {
                await fetchJson('/api/v2/questions', {
                    method: 'POST',
                    body: JSON.stringify({
                        question: {
                            content: document.getElementById('create-content').value,
                            answer: document.getElementById('create-answer').value,
                            score: parseFloat(document.getElementById('create-score').value)
                        },
                        target_dbs: target
                    })
                });
                e.target.reset();
                document.querySelectorAll('.target-db').forEach(el => el.checked = true);
                await loadQuestions();
            } catch (err) {
                alert('创建失败：' + err.message);
            }
        });

        function openEdit(btn) {
            document.getElementById('edit-guid').value = btn.dataset.guid;
            document.getElementById('edit-content').value = btn.dataset.content;
            document.getElementById('edit-answer').value = btn.dataset.answer;
            document.getElementById('edit-score').value = btn.dataset.score;
            const modal = new bootstrap.Modal(document.getElementById('edit-modal'));
            modal.show();
        }

        document.getElementById('save-edit').addEventListener('click', async () => {
            const guid = document.getElementById('edit-guid').value;
            const targets = selectedTargets('.edit-target');
            if (!targets.length) {
                alert('请选择至少一个数据库');
                return;
            }
            try {
                await fetchJson(`/api/v2/questions/${guid}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        question: {
                            content: document.getElementById('edit-content').value,
                            answer: document.getElementById('edit-answer').value,
                            score: parseFloat(document.getElementById('edit-score').value)
                        },
                        target_dbs: targets
                    })
                });
                bootstrap.Modal.getInstance(document.getElementById('edit-modal')).hide();
                await loadQuestions();
                await loadTasks();
            } catch (err) {
                alert('更新失败：' + err.message);
            }
        });

        async function confirmDelete(guid) {
            if (!confirm('删除后将记录同步任务，确定删除该题目吗？')) return;
            try {
                await fetchJson(`/api/v2/questions/${guid}`, {
                    method: 'DELETE',
                    body: JSON.stringify({ target_dbs: ['mysql', 'sqlserver', 'oracle'] })
                });
                await loadQuestions();
                await loadTasks();
            } catch (err) {
                alert('删除失败：' + err.message);
            }
        }

        function renderTasks(list) {
            const body = document.getElementById('tasks-body');
            if (!list.length) {
                body.innerHTML = '<tr><td colspan="4" class="text-center text-muted">暂无任务</td></tr>';
                return;
            }
            body.innerHTML = list.map(t => `
                <tr>
                    <td>${t.id}</td>
                    <td>${t.target_db}</td>
                    <td><span class="badge ${t.sync_status === 'PENDING' ? 'bg-warning text-dark' : (t.sync_status === 'FAILED' ? 'bg-danger' : 'bg-success')}">${t.sync_status}</span></td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="executeTask(${t.id})" ${t.sync_status === 'SUCCESS' ? 'disabled' : ''}>执行</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadTasks() {
            try {
                const data = await fetchJson('/api/v2/sync/tasks?limit=30');
                renderTasks(data);
            } catch (err) {
                alert('加载同步任务失败：' + err.message);
            }
        }

        async function executeTask(id) {
            try {
                await fetchJson(`/api/v2/sync/tasks/${id}/execute`, { method: 'POST' });
                await loadTasks();
                await loadQuestions();
            } catch (err) {
                alert('执行失败：' + err.message);
            }
        }

        async function loadUser() {
            try {
                const data = await fetchJson('/api/v2/auth/me');
                document.getElementById('nav-username').textContent = data.username;
                document.getElementById('nav-role').textContent = data.role;
            } catch (err) {
                logout();
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userInfo');
            window.location.href = 'login.html';
        }

        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('refresh-status').addEventListener('click', loadDbStatus);
        document.getElementById('refresh-tasks').addEventListener('click', loadTasks);
        document.getElementById('search-btn').addEventListener('click', loadQuestions);

        async function bootstrapApp() {
            if (!requireLogin()) return;
            await loadUser();
            await Promise.all([loadDbStatus(), loadQuestions(), loadTasks()]);
            setInterval(loadDbStatus, 30000);
            setInterval(loadTasks, 30000);
        }

        bootstrapApp();
    </script>
</body>
</html>
